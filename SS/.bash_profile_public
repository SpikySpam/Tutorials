#!/bin/bash

history -c
clear
export DIV="--------------------------------------------------"

echo $DIV
echo üòé LOADING BASH PROFILE INTO MEMORY
echo $DIV

# üíæ SET PATHS
export TF_VAR_PATH_MAIN=$TF_VAR_PATH/SS
export TF_VAR_PATH_APP=$TF_VAR_PATH/SS.APP
export TF_VAR_PATH_CLI=$TF_VAR_PATH/SS/CLI
export PATH="$TF_VAR_PATH_CLI:$PATH"

# üåê CURRENT ENVIRONMENT
export TF_VAR_DOMAIN="example.com"

# üîë SET SECRETS
# -- google
export TF_VAR_GOOGLE_TEXTTOSPEECH_API_KEY="YourGoogleTextToSpeechApiKey"
# -- npm
export TF_VAR_NPM_USER="admin@"$TF_VAR_DOMAIN
export TF_VAR_NPM_PASSWORD="changeme"
# -- mail-in-a-box
export TF_VAR_MAILINABOX_DOMAIN="box."$TF_VAR_DOMAIN
export TF_VAR_MAILINABOX_USER="admin@"$TF_VAR_DOMAIN
export TF_VAR_MAILINABOX_PASSWORD="UltraSecretPassword123!"
# -- postgres
export TF_VAR_POSTGRES_NAME="postgres"
export TF_VAR_POSTGRES_USER="SomeUsername"
export TF_VAR_POSTGRES_PASSWORD="UltraSecretPassword123!"
# -- mysql
export TF_VAR_MYSQL_NAME="mysql"
export TF_VAR_MYSQL_USER="SomeUsername"
export TF_VAR_MYSQL_PASSWORD="UltraSecretPassword123!"
# -- redis
export TF_VAR_REDIS_NAME="redis"
export TF_VAR_REDIS_USER="SomeUsername"
export TF_VAR_REDIS_PASSWORD="UltraSecretPassword123!"
# -- prometheus
export TF_VAR_PROMETHEUS_NAME="prometheus"
export TF_VAR_PROMETHEUS_USER="SomeUsername"
export TF_VAR_PROMETHEUS_PASSWORD="UltraSecretPassword123!"
# -- elasticsearch
export TF_VAR_ELASTICSEARCH_NAME="elasticsearch"
export TF_VAR_ELASTICSEARCH_USER="SomeUsername"
export TF_VAR_ELASTICSEARCH_PASSWORD="UltraSecretPassword123!"
# -- kibana
export TF_VAR_KIBANA_NAME="kibana"
# -- pgadmin
export TF_VAR_PGADMIN_NAME="pgadmin"
export TF_VAR_PGADMIN_USER=$TF_VAR_MAILINABOX_USER
export TF_VAR_PGADMIN_PASSWORD="UltraSecretPassword123!"
# -- phpmyadmin
export TF_VAR_PHPMYADMIN_NAME="phpmyadmin"
# -- vaultwarden
export TF_VAR_VAULTWARDEN_NAME="vaultwarden"
export TF_VAR_VAULTWARDEN_DOMAIN=$TF_VAR_VAULTWARDEN_NAME"."$TF_VAR_DOMAIN
export TF_VAR_VAULTWARDEN_ADMIN_PASSWORD="UltraSecretPassword123!"
export TF_VAR_VAULTWARDEN_ADMIN_TOKEN='$argon2id$v=19$m=65540,t=3,p=4$gxCIeCjT3gHdbVwWKd86lHjq1wWp6a9+NlScRmaeBOw$XKlvjpjCIjy6kfVPjSpOHe2mjA5TOeoxPwLnb9uzYRY'

# ‚úâÔ∏è SMTP
# -- box
export TF_VAR_SMTP_HOST=$TF_VAR_MAILINABOX_DOMAIN
export TF_VAR_SMTP_SECURITY="starttls"
export TF_VAR_SMTP_PORT=587
export TF_VAR_SMTP_USERNAME=$TF_VAR_MAILINABOX_USER
export TF_VAR_SMTP_PASSWORD=$TF_VAR_MAILINABOX_PASSWORD
# -- gmail (overrides box in case port 25 is blocked)
export TF_VAR_SMTP_HOST="smtp.gmail.com"
export TF_VAR_SMTP_SECURITY="starttls"
export TF_VAR_SMTP_PORT=587
export TF_VAR_SMTP_USERNAME="example@gmail.com"
export TF_VAR_SMTP_PASSWORD="UltraSecretPassword123!"

# 2Ô∏è‚É£ SET ALIASSES
alias cdss='cd $TF_VAR_PATH; clear'
alias k='kubectl'
alias t='terraform'
alias ti='t init'
alias ta='t apply'
alias taa='ta -auto-approve'
alias taar='terraform apply -refresh=false -auto-approve'
alias tp='t plan'
alias tpr='tp -refresh=false'
alias td='t destroy'
alias tda='td -auto-approve'
alias tdar='tda -refresh=false'
alias tv='t validate'
alias tr='t refresh'

# üöÄ ----------------------------------
#              START SCRIPT
# üöÄ ----------------------------------
export TF_VAR_AUTOSTART=false
export INITIALIZE=true

# -- INITIALIZE
initialize () {

  if [ $INITIALIZE == false ]; then
    echo
    echo ‚úÖ "Press ENTER to CONTINUE"
    echo ‚ùå "Press CTRL+C to EXIT"
    echo $DIV
    if [ $TF_VAR_C_AUTOSTART == false ]; then
      read
    fi
  fi

}

# -- LOAD ENVIRONMENT VARIABLES
load_env_vars () {
  source $TF_VAR_PATH_MAIN/version/app/version.sh
  source $TF_VAR_PATH_MAIN/version/docker/version.sh
  source $TF_VAR_PATH_MAIN/version/helm/version.sh
  source $TF_VAR_PATH_MAIN/version/terraform/version.sh
  source $TF_VAR_PATH_MAIN/version/cli/version.sh
  source $TF_VAR_PATH_MAIN/version/cluster/version.sh

  source $TF_VAR_PATH_MAIN/ports.sh
}

# -- INSTALL CLI TOOLS
install_cli () {
  chmod +x $TF_VAR_PATH_MAIN/cli.sh
  $TF_VAR_PATH_MAIN/cli.sh
}

# -- FINALIZE
finalize () {

  echo $DIV
  echo ‚úÖ "ALL DONE"
  echo $DIV

}

#‚ùóDon't include commands that need interaction before INITIALIZE is set to FALSE.
#‚ùóThis script will be called from ~/.bash_profile in various places and needs to exit.

load_env_vars
initialize
install_cli
finalize

export INITIALIZE=false
